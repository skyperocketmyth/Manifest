<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Tote QC Check</title>
  <!-- PWA Meta Tags -->
  <meta name="theme-color" content="#4285F4">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="apple-mobile-web-app-title" content="Your App Name">
  <link rel="apple-touch-icon" href="ICON_URL_192x192">


    <!-- Manifest Link -->
  <link rel="manifest" href="https://skyperocketmyth.github.io/Manifest/manifest.json">



  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    body {
      font-family: Arial, sans-serif;
      background-color: #f0f2f5;
      color: #333;
      font-size: 16px;
      overflow-y: auto;
      height: 100vh;
    }
    .container {
      width: 100%;
      max-width: 500px;
      min-height: 100vh;
      padding: 10px;
      margin: 0 auto;
      background: #fff;
      overflow-y: auto;
    }
    .header {
      position: sticky;
      top: 0;
      background: #fff;
      padding: 8px 0;
      border-bottom: 2px solid #007bff;
      margin-bottom: 15px;
      z-index: 10;
    }
    .data-status {
     font-size: 0.9rem;
  margin: 5px 0 5px 0;
  padding: 8px;
  text-align: center;
  background: #fffde7;
  border-radius: 4px;
  border-left: 4px solid #ffd600;
  border-right: 4px solid #ffd600;
  width: 300px;
  max-width: 300px;
  margin-left: auto;
  margin-right: auto;
    }
    .data-status.loading {
      background-color: #fff3e0;
      border-color: #ff9800;
    }
    .data-status.success {
      background-color: #e8f5e9;
      border-color: #4caf50;
    }
    .data-status.error {
      background-color: #ffebee;
      border-color: #f44336;
    }
    h1 {
  font-size: 1.2rem;
  margin: 15px 0 10px 0;
  padding: 8px;
  text-align: center;
  background: #f0f8ff;
  border-radius: 4px;
  border-left: 4px solid #007bff;
  border-right: 4px solid #007bff;
  width: 480px;
  max-width: 480px;
  margin-left: auto;
  margin-right: auto;
    }
    h2 {
  font-size: 1.2rem;
  margin: 15px 0 10px 0;
  padding: 8px;
  text-align: center;
  background: #f0f8ff;
  border-radius: 4px;
  border-left: 4px solid #007bff;
  border-right: 4px solid #007bff;
  width: 300px;
  max-width: 300px;
  margin-left: auto;
  margin-right: auto;
    }
    form label {
      font-weight: bold;
      display: block;
      margin-top: 10px;
      font-size: 1rem;
      color: #555;
    }
    form input,
    form select {
      width: 100%;
      padding: 12px;
      margin-top: 4px;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 1rem;
    }
    .scan-container {
      display: flex;
      align-items: center;
      gap: 10px;
      margin: 8px 0;
      padding: 8px;
      border-radius: 6px;
      background-color: #f9f9f9;
      transition: background-color 0.3s;
    }
    .scan-container:focus-within {
      background-color: #e6f3ff;
    }
    .scan-status {
      width: 50px;
      height: 50px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      border-radius: 50%;
      flex-shrink: 0;
      background: #f0f0f0;
    }
    .scan-input {
      height: 50px;
      background-color: #fff;
      font-size: 1.3rem;
      font-weight: 500;
      flex-grow: 0;
      width: 250px; /* Added fixed width suitable for 13-15 digits */
      max-width: 250px; 
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .scan-valid {
      background-color: #e6ffe6;
      color: #4CAF50;
    }
    .scan-invalid {
      background-color: #ffebee;
      color: #ff0000;
    }
    #orderDate,
    #storeName,
    #scanDropID
    #PalletID {
      height: 50px;
      font-size: 1.3rem;
      width: 300px; /* Added fixed width suitable for 13-15 digits */
      max-width: 300px;
    }
    .scanned-item {
      font-size: 1.2rem;
      font-weight: bold;
      color: #333;
      padding: 10px;
      margin: 8px 0;
      background-color: #f0f8ff;
      border-radius: 6px;
      border-left: 4px solid #007bff;
    }
    form button {
      background-color: #007bff;
      color: white;
      border: none;
      cursor: pointer;
      margin: 10px 0;
      height: 54px;
      font-weight: bold;
      font-size: 1.1rem;
      width: 300px; 
      max-width: 300px; 
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 6px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
      transition: background-color 0.2s;
    }
    form button:hover {
      background-color: #0056b3;
    }
    form button:disabled {
      background-color: #cccccc;
    }
    .refresh-button {
      padding: 5px 10px;
      background: #4caf50;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.9rem;
      margin-left: 10px;
    }
    .error {
      border: 3px solid #ff4d4d !important;
      background-color: #ffebee !important;
    }
    .valid {
      border: 3px solid #4CAF50 !important;
      background-color: #e8f5e9 !important;
    }
    .error-message {
      color: #ff0000;
      font-size: 1.1rem;
      font-weight: bold;
      padding: 10px;
      margin: 5px 0 10px 0;
      background-color: #ffebee;
      border-radius: 4px;
      border-left: 4px solid #ff0000;
      display: none;
      animation: flash 1s infinite;
    }
    @keyframes flash {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    .processing {
      opacity: 0.7;
      cursor: not-allowed !important;
    }
    .spinner {
      display: inline-block;
      margin-left: 8px;
      width: 20px;
      height: 20px;
      border: 3px solid #ffffff;
      border-radius: 50%;
      border-top-color: transparent;
      animation: spin 1s linear infinite;
    }
    .small-spinner {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid #007bff;
      border-radius: 50%;
      border-top-color: transparent;
      animation: spin 1s linear infinite;
      vertical-align: middle;
      margin-right: 5px;
    }
    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }
    #scansContainer {
      margin-top: 15px;
      padding-bottom: 80px;
    }
    .button-container {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  padding: 10px 15px;
  background: #fff;
  box-shadow: 0 -3px 10px rgba(0,0,0,0.1);
  z-index: 100;
  display: flex;
  justify-content: center;
    }
    .input-group {
      margin-bottom: 15px;
      border-radius: 6px;
      overflow: hidden;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .active-scan {
      border: 2px solid #007bff;
      box-shadow: 0 0 8px rgba(0, 123, 255, 0.4);
    }
    .barcode-display {
      font-family: 'Courier New', monospace;
      padding: 8px 10px;
      margin: 0 0 5px 0;
      font-size: 1.1rem;
      font-weight: bold;
      color: #333;
      background-color: #f8f8f8;
      border-radius: 4px;
      display: none;
      word-break: break-all;
    }
    .excess-counter {
      display: inline-block;
      background-color: #ff4d4d;
      color: white;
      border-radius: 4px;
      padding: 2px 6px;
      margin-left: 5px;
      font-size: 0.9rem;
      font-weight: bold;
      animation: pulse 1s infinite;
    }
    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.1); }
    }
    .count-display {
      display: flex;
      align-items: center;
      margin: 0 0 10px 0;
      padding: 5px 10px;
      background-color: #f0f8ff;
      border-radius: 4px;
      font-size: 1rem;
    }
    .count-warning {
      color: #ff4d4d;
      font-weight: bold;
      animation: flash 1s infinite;
    }
    .data-timestamp {
      font-size: 0.8rem;
      color: #777;
      text-align: right;
      margin-top: 2px;
    }
    @media screen and (max-width: 480px) {
      .container {
        padding: 8px;
      }
      .scan-input {
        font-size: 1.1rem;
      }
      h1 {
        font-size: 1.3rem;
      }
      h2 {
        font-size: 1.1rem;
      }
    }

.modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.5);
  z-index: 1000;
}

.modal-content {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background-color: white;
  padding: 20px;
  border-radius: 8px;
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
  text-align: center;
  max-width: 80%;
  z-index: 1001;
}

.modal-spinner {
  display: inline-block;
  width: 30px;
  height: 30px;
  border: 3px solid #007bff;
  border-radius: 50%;
  border-top-color: transparent;
  animation: spin 1s linear infinite;
  margin: 10px 0;
}

.modal-button {
  background-color: #007bff;
  color: white;
  border: none;
  padding: 8px 15px;
  border-radius: 4px;
  cursor: pointer;
  margin-top: 10px;
  font-weight: bold;
}

.modal-success {
  color: #4CAF50;
  font-size: 3rem;
  margin: 10px 0;
}

.modal-error {
  color: #f44336;
  font-size: 3rem;
  margin: 10px 0;
}




  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>Tote QC Check</h1>
      <div id="dataStatus" class="data-status">
        Waiting for data...
      </div>
    </div>
    <form id="orderForm">
      <div class="input-group">
        <label for="orderDate">Order Date:</label>
        <input type="date" id="orderDate" required />
      </div>
     
      <div class="input-group">
        <label for="storeName">Store Name:</label>
        <select id="storeName" required>
          <option value="" disabled selected>Select Store</option>
          <option value="Quik Business Bay">Quik Business Bay</option>
          <option value="Quik Business Bay 2">Quik Business Bay 2</option>
          <option value="Quik Arjan">Quik Arjan</option>
          <option value="Quik Barsha">Quik Barsha</option>
          <option value="Quik Concord">Quik Concord</option>
          <option value="Quik DFP">Quik DFP</option>
          <option value="Quik DFC">Quik DFC</option>
          <option value="Quik DSO">Quik DSO</option>
          <option value="Quik DWTC">Quik DWTC</option>
          <option value="Quik Etisalat">Quik Etisalat</option>
          <option value="Quik JLT">Quik JLT</option>
          <option value="Quik JVC">Quik JVC</option>
          <option value="Quik Marina">Quik Marina</option>
          <option value="Quik Motor City">Quik Motor City</option>
          <option value="Quik Murjan">Quik Murjan</option>
          <option value="Quik Raffa">Quik Raffa</option>
          <option value="Quik Raffa 2">Quik Raffa 2</option>
          <option value="Quik Raha">Quik Raha</option>
          <option value="Quik Safa">Quik Safa</option>
          <option value="Quik Umm Suqueim">Quik Umm Suqueim</option>
        </select>
      </div>
     
      <div class="input-group">
        <label for="scanDropID">Scan Drop ID:</label>
        <input type="text" id="scanDropID" required class="scan-input" />
      </div>

            <div class="input-group">
        <label for="PalletID">Pallet ID:</label>
        <input type="text" id="PalletID" required class="scan-input" />
      </div>
     
      <div id="excessCountersContainer" style="display:none;">
        <h3 style="margin: 15px 0 5px 0;">Excess Item Warnings:</h3>
        <div id="excessCounters" style="margin-bottom: 10px;"></div>
      </div>
     
      <h2>Scan Barcode of Items </h2>


            <div id="loadingModal" class="modal">
  <div class="modal-content">
    <h3>Processing Your Submission</h3>
    <div class="modal-spinner"></div>
    <p>Please wait while we process your data...</p>
  </div>
</div>

<div id="successModal" class="modal">
  <div class="modal-content">
    <div class="modal-success">✅</div>
    <h3>Success!</h3>
    <p>Form submitted successfully!</p>
    <button class="modal-button" onclick="closeModal('successModal')">OK</button>
  </div>
</div>

<div id="errorModal" class="modal">
  <div class="modal-content">
    <div class="modal-error">❌</div>
    <h3>Error</h3>
    <p id="errorMessage">There was an error submitting the form.</p>
    <button class="modal-button" onclick="closeModal('errorModal')">OK</button>
  </div>
</div>


      <div id="scansContainer"></div>
     
      <div class="button-container">
        <button type="button" id="submitButton">
          <span>Submit</span>
          <span id="submitSpinner" class="spinner" style="display: none;"></span>
        </button>
      </div>

    </form>
  </div>
  <script>

        <!-- Link to your JS file -->
  src="code.js"




    let audioContext;
    let lastFetchTime = null;
    let fetchInProgress = false;
   
    function initAudio() {
      audioContext = new (window.AudioContext || window.webkitAudioContext)();
    }
    // Initialize audio on first user interaction
    document.addEventListener('click', function() {
      if (!audioContext) {
        initAudio();
      }
    }, { once: true });
    function playBuzzerSound() {
      if (!audioContext) {
        initAudio();
      }
     
      const oscillator = audioContext.createOscillator();
      const gainNode = audioContext.createGain();
     
      // Connect oscillator to gain node and gain node to audio context
      oscillator.connect(gainNode);
      gainNode.connect(audioContext.destination);
     
      // Set oscillator properties for a buzzer-like sound
      oscillator.type = 'square';
      oscillator.frequency.setValueAtTime(150, audioContext.currentTime); // Low frequency for buzzer sound
     
      // Set volume
      gainNode.gain.setValueAtTime(0.3, audioContext.currentTime); // Reduced volume to 30%
     
      // Start sound
      oscillator.start();
     
      // Create buzzer effect with frequency modulation
      let counter = 0;
      const intervalId = setInterval(() => {
        oscillator.frequency.setValueAtTime(
          counter % 2 === 0 ? 150 : 180,
          audioContext.currentTime
        );
        counter++;
        if (counter >= 6) { // 3 buzzes
          clearInterval(intervalId);
        }
      }, 100);
     
      // Stop sound after 600ms
      setTimeout(() => {
        oscillator.stop();
        oscillator.disconnect();
        gainNode.disconnect();
      }, 600);
    }
    function vibrateDevice() {
      if (navigator.vibrate) {
        // Vibrate in a pattern to match the buzzer (3 pulses)
        navigator.vibrate([100, 100, 100, 100, 100, 100]);
      }
    }
   
    // Store both valid barcodes and their quantities
    let barcodeData = {};
   
    const maxScanCount = 100;
   
    document.getElementById("storeName").addEventListener("change", function () {
      fetchBarcodeData();
      createScanFields();
    });
   
   
   
function updateDataStatus(status, message) {
  const statusElement = document.getElementById("dataStatus");
  statusElement.className = "data-status " + status;
 
  if (status === "loading") {
    statusElement.innerHTML = '<span class="small-spinner"></span> Loading data...';
  } else if (status === "success") {
    statusElement.innerHTML = '✅ ' + message;
  } else if (status === "error") {
    statusElement.innerHTML = '❌ ' + message;
  } else {
    statusElement.textContent = message;
  }
}
   
    function fetchBarcodeData(isManualRefresh = false) {
      const storeName = document.getElementById("storeName").value;
      if (!storeName) return;
     
      if (fetchInProgress) {
        if (isManualRefresh) {
          updateDataStatus("error", "Data refresh already in progress");
        }
        return;
      }
     
      fetchInProgress = true;
      updateDataStatus("loading", "Loading barcode data...");
     
      // Update to get both barcodes and quantities
      google.script.run
        .withSuccessHandler(function(data) {
          barcodeData = data;
          lastFetchTime = new Date();
          fetchInProgress = false;
         
          // Update scan validations after data refresh
          updateAllScans();
         
          // Update UI to show success
          updateDataStatus("success", "Data loaded successfully");
         
          console.log("Updated Barcode Data: ", barcodeData);
        })
        .withFailureHandler(function(error) {
          fetchInProgress = false;
          console.error("Error fetching data:", error);
          updateDataStatus("error", "Failed to load data. Please try again.");
        })
        .getRealTimeBarcodeData(storeName);
    }
   
    function updateAllScans() {
      // Revalidate all existing scans with the new data
      for (let i = 1; i <= maxScanCount; i++) {
        const input = document.getElementById(`itemScan${i}`);
        if (input && input.value.trim()) {
          validateBarcode(input, i, true);
        }
      }
      updateExcessCounters();
    }
   
 
   
    function createScanFields() {
      const container = document.getElementById("scansContainer");
      container.innerHTML = "";
     
      for (let i = 1; i <= maxScanCount; i++) {
        const label = document.createElement("label");
        label.textContent = `Item ${i}:`;
       
        const scanContainer = document.createElement("div");
        scanContainer.className = "scan-container";
        scanContainer.id = `scanContainer${i}`;
       
        const statusIndicator = document.createElement("div");
        statusIndicator.className = "scan-status";
        statusIndicator.id = `status${i}`;
       
        const input = document.createElement("input");
        input.type = "text";
        input.id = `itemScan${i}`;
        input.className = "scan-input";
        input.placeholder = "Scan barcode";
        input.addEventListener("focus", function() {
          // Highlight active scanning field
          const allContainers = document.querySelectorAll(".scan-container");
          allContainers.forEach(c => c.classList.remove("active-scan"));
          scanContainer.classList.add("active-scan");
         
          // Ensure good visibility when focused
          scanContainer.scrollIntoView({ behavior: 'smooth', block: 'center' });
        });
        input.addEventListener("input", function() {
          validateBarcode(input, i);
        });
       
        const barcodeDisplay = document.createElement("div");
        barcodeDisplay.className = "barcode-display";
        barcodeDisplay.id = `barcodeDisplay${i}`;
       
        const errorMsg = document.createElement("div");
        errorMsg.className = "error-message";
        errorMsg.textContent = "Invalid barcode!";
        errorMsg.id = `error${i}`;
       
        container.appendChild(label);
        scanContainer.appendChild(statusIndicator);
        scanContainer.appendChild(input);
        container.appendChild(scanContainer);
        container.appendChild(barcodeDisplay);
        container.appendChild(errorMsg);
      }
     
      // Reset excess counters
      document.getElementById("excessCountersContainer").style.display = "none";
      document.getElementById("excessCounters").innerHTML = "";
     
      const firstInput = document.getElementById("itemScan1");
      if (firstInput) {
        firstInput.focus();
        const firstContainer = document.getElementById("scanContainer1");
        if (firstContainer) {
          firstContainer.classList.add("active-scan");
        }
        firstInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }
    }
   
    function countValidScannedBarcodes() {
      // Count actual barcodes that exist in the input fields
      const scannedBarcodes = {};
     
      for (let i = 1; i <= maxScanCount; i++) {
        const input = document.getElementById(`itemScan${i}`);
        if (input && input.value.trim()) {
          const barcode = input.value.trim();
         
          // Check if it's a valid barcode
          let normalizedBarcode = barcode;
          let isValidBarcode = !!barcodeData[barcode];
         
          if (!isValidBarcode && barcode.startsWith("0")) {
            normalizedBarcode = barcode.slice(1);
            isValidBarcode = !!barcodeData[normalizedBarcode];
          }
         
          if (isValidBarcode) {
            if (!scannedBarcodes[normalizedBarcode]) {
              scannedBarcodes[normalizedBarcode] = 1;
            } else {
              scannedBarcodes[normalizedBarcode]++;
            }
          }
        }
      }
     
      return scannedBarcodes;
    }
   
    function updateExcessCounters() {
      const excessCountersContainer = document.getElementById("excessCountersContainer");
      const excessCounters = document.getElementById("excessCounters");
      excessCounters.innerHTML = "";
     
      // Get current count of scanned barcodes from input fields
      const scannedBarcodes = countValidScannedBarcodes();
     
      let hasExcess = false;
     
      // Check each barcode for excess scans
      for (const barcode in scannedBarcodes) {
        if (scannedBarcodes[barcode] > barcodeData[barcode]) {
          hasExcess = true;
         
          const excessItem = document.createElement("div");
          excessItem.className = "count-display count-warning";
          excessItem.innerHTML = `
            <strong>⚠️ Barcode ${barcode}:</strong>
            Scanned ${scannedBarcodes[barcode]} times,
            Max allowed: ${barcodeData[barcode]}
          `;
          excessCounters.appendChild(excessItem);
        }
      }
     
      excessCountersContainer.style.display = hasExcess ? "block" : "none";
    }
   
    function validateBarcode(input, index, skipFocus = false) {
      const barcode = input.value.trim();
      const errorMsg = document.getElementById(`error${index}`);
      const statusIndicator = document.getElementById(`status${index}`);
      const barcodeDisplay = document.getElementById(`barcodeDisplay${index}`);
     
 
     
      // Check if barcode is in the data or if it's the same barcode with a leading zero removed
      let normalizedBarcode = barcode;
      let isValidBarcode = !!barcodeData[barcode];
     
      if (!isValidBarcode && barcode.startsWith("0")) {
        normalizedBarcode = barcode.slice(1);
        isValidBarcode = !!barcodeData[normalizedBarcode];
      }
     
      // Get current count of scanned barcodes directly from input fields
      const scannedBarcodes = countValidScannedBarcodes();
     
      if (barcode && isValidBarcode) {
        // Check if the scan count exceeds the allowed quantity
        const quantity = barcodeData[normalizedBarcode];
        const isExcessScan = scannedBarcodes[normalizedBarcode] > quantity;
       
        if (isExcessScan) {
          // This is an excess scan
          input.classList.remove("valid");
          input.classList.add("error");
          statusIndicator.className = "scan-status scan-invalid";
          statusIndicator.innerHTML = "❌";
          errorMsg.textContent = `Excess scan! Max quantity for this item is ${quantity}`;
          errorMsg.style.display = "block";
         
          // Add error feedback
          playBuzzerSound();
          vibrateDevice();
         
          // Update excess counters immediately
          updateExcessCounters();
        } else {
          // Valid scan within quantity limits
          input.classList.remove("error");
          input.classList.add("valid");
          errorMsg.style.display = "none";
          statusIndicator.className = "scan-status scan-valid";
          statusIndicator.innerHTML = "✅";
         
          // Update counts
          updateExcessCounters();
         
          if (!skipFocus && index < maxScanCount) {
            const nextInput = document.getElementById(`itemScan${index + 1}`);
            if (nextInput) {
              // Clear active scan highlighting
              const allContainers = document.querySelectorAll(".scan-container");
              allContainers.forEach(c => c.classList.remove("active-scan"));
             
              // Highlight next container
              const nextContainer = document.getElementById(`scanContainer${index + 1}`);
              if (nextContainer) {
                nextContainer.classList.add("active-scan");
              }
             
              nextInput.focus();
              nextInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
          }
        }
      } else if (barcode) {
        // Invalid barcode (not in the data)
        input.classList.remove("valid");
        input.classList.add("error");
        statusIndicator.className = "scan-status scan-invalid";
        statusIndicator.innerHTML = "❌";
        errorMsg.textContent = "Invalid barcode!";
        errorMsg.style.display = "block";
       
        // Add error feedback
        playBuzzerSound();
        vibrateDevice();
      } else {
        // Empty input
        input.classList.remove("error");
        input.classList.remove("valid");
        statusIndicator.className = "scan-status";
        statusIndicator.textContent = "";
        errorMsg.style.display = "none";
       
        // Make sure to update excess counters when an entry is deleted
        updateExcessCounters();
      }
    }

       function showModal(id) {
  document.getElementById(id).style.display = 'block';
}

function closeModal(id) {
  document.getElementById(id).style.display = 'none';
  if (id === 'successModal') {
    document.getElementById("orderForm").reset();
    createScanFields();
  }
}
   
    function submitForm() {
      const submitButton = document.getElementById("submitButton");
      const submitSpinner = document.getElementById("submitSpinner");
      const buttonText = submitButton.querySelector("span");
     
      if (submitButton.classList.contains('processing')) {
        return;
      }
      const orderDate = document.getElementById("orderDate").value;
      const storeName = document.getElementById("storeName").value;
      const scanDropID = document.getElementById("scanDropID").value;
      const PalletID = document.getElementById("PalletID").value;
      if (!orderDate || !storeName) {
        alert("Please fill in all required fields (Order Date and Store Name)");
        return;
      }
      const inputs = document.querySelectorAll("input");
      const errors = Array.from(inputs).filter(input => input.classList.contains("error"));
      if (errors.length > 0) {
        alert("Fix the Errors before submitting the form.");
        return;
      }
      const formData = {
        orderDate: orderDate,
        storeName: storeName,
        scanDropID: scanDropID,
        PalletID: PalletID,
        itemScans: []
      };
      for (let i = 1; i <= maxScanCount; i++) {
        const input = document.getElementById(`itemScan${i}`);
        if (input && input.value && !input.classList.contains("error")) {
          formData.itemScans.push(input.value);
        }
      }
      submitButton.classList.add('processing');
      submitButton.disabled = true;
      buttonText.textContent = "Processing...";
      submitSpinner.style.display = "inline-block";
        // Show loading modal instead of alert
  showModal('loadingModal');
     function resetButton() {
    submitButton.classList.remove('processing');
    submitButton.disabled = false;
    buttonText.textContent = "Submit";
    submitSpinner.style.display = "none";
    closeModal('loadingModal');
  }
    google.script.run
    .withSuccessHandler(function(result) {
      console.log("Submission result:", result);
      resetButton();
      
      if (result.includes("Success")) {
        showModal('successModal');
      } else {
        document.getElementById("errorMessage").textContent = "Submission error: " + result;
        showModal('errorModal');
      }
    })
    .withFailureHandler(function(error) {
      console.error("Submission error:", error);
      resetButton();
      document.getElementById("errorMessage").textContent = "Error submitting form: " + (error.message || error);
      showModal('errorModal');
    })
    .submitFormData(formData);
}
    document.getElementById("submitButton").addEventListener("click", submitForm);
    createScanFields();
    document.addEventListener('touchstart', function(event) {
      if (event.touches.length > 1) {
        event.preventDefault();
      }
    }, { passive: false });
  </script>
</body>
</html>
